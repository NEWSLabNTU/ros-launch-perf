# Autoware Test Scripts

This directory contains scripts for testing `dump_launch` and `play_launch` with Autoware.

## Setup

1. **Create the autoware symlink** pointing to your Autoware workspace:
   ```bash
   ln -s /path/to/your/autoware autoware
   ```

   The symlink should point to a built Autoware workspace containing `install/setup.bash`.

2. **Ensure you have the required map data**:
   ```bash
   # The script expects the sample map at:
   $HOME/autoware_map/sample-map-planning
   ```

## Usage

### Using Makefile (Recommended)

```bash
# Show available targets
make help

# Start Autoware with play_launch
make run

# Run autonomous driving test (requires Autoware running)
make test

# Run complete test sequence (launch + autonomous test)
make full-test

# Clean up orphan ROS nodes
make clean
```

The Makefile automatically sources the Autoware environment from `autoware/install/setup.bash`.

### Using Shell Scripts (Legacy)

```bash
# Start Autoware
./run.sh

# Run full test sequence
bash run_full_test.sh
```

## Files

- `Makefile` - Build automation for Autoware tests
- `run.sh` - Main test script (starts Autoware with play_launch)
- `test_autonomous_drive.py` - Python script to automate autonomous driving test
- `run_full_test.sh` - Complete automated test sequence
- `poses_config.yaml` - Validated poses for sample-map-planning
- `autoware` - Symlink to Autoware installation (you must create this)
- `record.json` - Generated by `dump_launch` (contains launch execution record)
- `play_log/` - Generated by `play_launch` (contains timestamped execution logs)

## Autonomous Driving Test

### Quick Start - Automated Test

Run the complete test sequence automatically:

```bash
make full-test
```

Or using the shell script:
```bash
bash run_full_test.sh
```

This will:
1. Start Autoware with play_launch
2. Wait for system to be ready (~60s)
3. Set initial pose
4. Set goal pose
5. Engage autonomous mode
6. Monitor for 60 seconds
7. Keep system running (press Ctrl+C to stop)

### Manual Test (Step-by-step)

1. Start Autoware in one terminal:
   ```bash
   make run
   ```

2. Wait ~60 seconds for system to initialize

3. In another terminal, run the autonomous driving test:
   ```bash
   make test
   ```

### Test Sequence Details

The autonomous driving test performs:

1. **Wait for Autoware** - Checks that critical topics are active:
   - `/map/vector_map`
   - `/api/operation_mode/state`
   - `/api/routing/state`

2. **Set Initial Pose** - Publishes to `/initialpose` topic to initialize localization

3. **Wait for Localization** - Waits 5s for localization to stabilize and checks:
   - `/tf` transforms
   - `/localization/kinematic_state`

4. **Set Route** - Calls `/api/routing/set_route_points` service

5. **Engage Autonomous** - Calls `/api/operation_mode/change_to_autonomous` service

6. **Monitor Progress** - Monitors vehicle state for specified duration

### Pose Configuration

Poses are loaded from `poses_config.yaml` in this directory.
These poses are validated for `sample-map-planning`.

## Troubleshooting

### Error: 'autoware' symlink not found
Create the symlink:
```bash
ln -s /path/to/autoware autoware
```

### Error: symlink points to non-existent directory
Update the symlink to point to a valid Autoware installation:
```bash
ln -sf /path/to/autoware autoware
```

### Error: Autoware installation appears to be incomplete
Ensure the symlink points to a built Autoware workspace that contains `install/setup.bash`:
```bash
ls -la autoware/install/setup.bash
```

## Configuration

### Makefile Variables

You can override these variables when running make:

```bash
make run MAP_PATH=/path/to/map VEHICLE_MODEL=my_vehicle
```

Available variables:
- `MAP_PATH` - Path to map data (default: `$HOME/autoware_map/sample-map-planning`)
- `VEHICLE_MODEL` - Vehicle model name (default: `sample_vehicle`)
- `SENSOR_MODEL` - Sensor model name (default: `sample_sensor_kit`)
- `SERVICE_TIMEOUT` - Container service timeout in seconds (default: 300)
- `LOAD_TIMEOUT` - Node load timeout in milliseconds (default: 60000)

### play_launch Flags

The following flags are used for Autoware testing:

- `--wait-for-service-ready` - Enable container service readiness checking via ROS service discovery
- `--service-ready-timeout-secs 300` - Wait up to 5 minutes for each container service to be ready
- `--load-node-timeout-millis 60000` - Wait up to 60 seconds for each composable node to load

These conservative timeouts are appropriate for Autoware's large number of containers and composable nodes, where DDS initialization can take significant time.
