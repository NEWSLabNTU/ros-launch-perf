#!/bin/bash
set -e

IO_HELPER="/usr/lib/play-launch/play_launch_io_helper"

if [ "$1" = "configure" ]; then
    echo "Setting up play-launch..."

    # Set capability on I/O helper for container monitoring
    if [ -f "${IO_HELPER}" ]; then
        if command -v setcap >/dev/null 2>&1; then
            echo "Setting CAP_SYS_PTRACE on I/O helper for container monitoring..."
            setcap cap_sys_ptrace+ep "${IO_HELPER}" 2>/dev/null || {
                echo "Warning: Failed to set CAP_SYS_PTRACE on ${IO_HELPER}"
                echo "I/O monitoring for privileged processes will be unavailable."
                echo "Run 'sudo setcap cap_sys_ptrace+ep ${IO_HELPER}' manually to enable."
            }
        else
            echo "Warning: setcap not found. I/O monitoring for containers disabled."
        fi
    fi

    echo "play-launch installed successfully!"
    echo ""
    echo "Usage:"
    echo "  source /opt/ros/humble/setup.bash"
    echo "  play_launch --help"
    echo "  play_launch launch <package> <launch_file>"
    echo "  play_launch plot"
    echo ""
    echo "Documentation: /usr/share/doc/play-launch/"
fi

exit 0
