# Autoware Planning Simulator Test

This directory contains test scripts for `dump_launch` and `play_launch` with Autoware planning simulator.

## Setup

1. **Create the autoware symlink** pointing to your Autoware workspace:
   ```bash
   ln -s /path/to/your/autoware autoware
   ```

   The symlink should point to a built Autoware workspace containing `install/setup.bash`.

2. **Ensure you have the required map data**:
   ```bash
   # The script expects the sample map at:
   $HOME/autoware_map/sample-map-planning
   ```

3. **(Optional) Install ros2systemd** for systemd-managed launches:
   ```bash
   # Install via pip
   pip3 install ros2systemd

   # Or install from source
   git clone https://github.com/ros-sys/ros2systemd.git
   cd ros2systemd
   pip3 install -e .
   ```

   With ros2systemd, you can run Autoware as a systemd user service, which provides:
   - Automatic process cleanup when stopping the service
   - Log management via journalctl
   - Service status monitoring
   - No orphan ROS nodes after stopping

## Directory Structure

```
test/autoware_planning_simulation/
├── Makefile              # Main test automation
├── README.md             # This file
├── autoware              # Symlink to Autoware workspace
├── cyclonedds.xml        # CycloneDDS configuration
├── record.json           # Launch execution record (generated)
├── poses_config.yaml     # Test poses configuration
├── play_log/             # Execution logs and metrics (generated)
└── scripts/              # Utility scripts
    ├── start-sim.sh                # Start simulator with play_launch
    ├── test_autonomous_drive.py    # Autonomous driving test
    ├── plot_resource_usage.py      # Plot generation tool
    └── kill_orphan_nodes.sh        # Cleanup utility
```

## Usage

### Using Makefile (Recommended)

```bash
# Show available targets
make help

# Start Autoware planning simulator with play_launch
make start-sim

# Start Autoware with ros2 systemd launch (runs as systemd user service)
make start-sim-systemd

# Manage the systemd service
make status-sim-systemd    # Check service status
make logs-sim-systemd      # View logs (follows in real-time)
make stop-sim-systemd      # Stop the service

# Run autonomous driving test (requires simulator running)
make drive

# Run complete test sequence (simulator + autonomous test)
make start-sim-and-drive

# Clean up orphan ROS nodes
make kill-orphans
```

The Makefile automatically sources the Autoware environment from `autoware/install/setup.bash`.

### Systemd Launch Benefits

When using `make start-sim-systemd`, the launch runs as a systemd user service, which provides several advantages:

1. **Automatic Cleanup**: All ROS nodes are properly terminated when the service is stopped (no orphan processes)
2. **Log Management**: Logs are stored in journalctl and can be viewed with `make logs-sim-systemd`
3. **Service Monitoring**: Check service status with `make status-sim-systemd`
4. **Persistent Logs**: Logs are preserved even after the service stops

The systemd service automatically handles environment setup (sources Autoware workspace) and CycloneDDS configuration.

### Using Scripts Directly

```bash
# Start simulator
bash scripts/start-sim.sh

# Run autonomous driving test (requires simulator running)
python3 scripts/test_autonomous_drive.py
```

## Files

- `Makefile` - Build automation for Autoware tests
- `cyclonedds.xml` - CycloneDDS configuration for localhost-only communication
- `scripts/start-sim.sh` - Starts Autoware planning simulator with play_launch
- `scripts/test_autonomous_drive.py` - Python script to automate autonomous driving test
- `scripts/plot_resource_usage.py` - Resource usage plotting tool
- `scripts/kill_orphan_nodes.sh` - Cleanup orphan ROS nodes
- `poses_config.yaml` - Validated poses for sample-map-planning
- `autoware` - Symlink to Autoware installation (you must create this)
- `record.json` - Generated by `dump_launch` (contains launch execution record)
- `play_log/` - Generated by `play_launch` (contains timestamped execution logs and metrics)

## Autonomous Driving Test

### Quick Start - Automated Test

Run the complete test sequence automatically:

```bash
make start-sim-and-drive
```

This will:
1. Start Autoware with play_launch
2. Wait for system to be ready (~60s)
3. Set initial pose
4. Set goal pose
5. Engage autonomous mode
6. Monitor for 60 seconds
7. Keep system running (press Ctrl+C to stop)

### Manual Test (Step-by-step)

1. Start Autoware planning simulator in one terminal:
   ```bash
   make start-sim
   ```

2. Wait ~60 seconds for system to initialize

3. In another terminal, run the autonomous driving test:
   ```bash
   make drive
   ```

### Test Sequence Details

The autonomous driving test performs:

1. **Wait for Autoware** - Checks that critical topics are active:
   - `/map/vector_map`
   - `/api/operation_mode/state`
   - `/api/routing/state`

2. **Set Initial Pose** - Publishes to `/initialpose` topic to initialize localization

3. **Wait for Localization** - Waits 5s for localization to stabilize and checks:
   - `/tf` transforms
   - `/localization/kinematic_state`

4. **Set Route** - Calls `/api/routing/set_route_points` service

5. **Engage Autonomous** - Calls `/api/operation_mode/change_to_autonomous` service

6. **Monitor Progress** - Monitors vehicle state for specified duration

### Pose Configuration

Poses are loaded from `poses_config.yaml` in this directory.
These poses are validated for `sample-map-planning`.

## Troubleshooting

### Error: 'autoware' symlink not found
Create the symlink:
```bash
ln -s /path/to/autoware autoware
```

### Error: symlink points to non-existent directory
Update the symlink to point to a valid Autoware installation:
```bash
ln -sf /path/to/autoware autoware
```

### Error: Autoware installation appears to be incomplete
Ensure the symlink points to a built Autoware workspace that contains `install/setup.bash`:
```bash
ls -la autoware/install/setup.bash
```

## Configuration

### Makefile Variables

You can override these variables when running make:

```bash
make start-sim MAP_PATH=/path/to/map
```

Available variables:
- `MAP_PATH` - Path to map data (default: `$HOME/autoware_map/sample-map-planning`)
- `SERVICE_TIMEOUT` - Container service timeout in seconds (default: 300)
- `LOAD_TIMEOUT` - Node load timeout in milliseconds (default: 60000)

### play_launch Flags

The following flags are used for Autoware testing:

- `--wait-for-service-ready` - Enable container service readiness checking via ROS service discovery
- `--service-ready-timeout-secs 300` - Wait up to 5 minutes for each container service to be ready
- `--load-node-timeout-millis 60000` - Wait up to 60 seconds for each composable node to load

These conservative timeouts are appropriate for Autoware's large number of containers and composable nodes, where DDS initialization can take significant time.

## Comparison Testing

To compare different launch methods:

```bash
# Test with play_launch
make start-sim

# Test with ros2 systemd launch (in a new terminal after killing play_launch)
make start-sim-systemd

# View systemd service logs
make logs-sim-systemd

# Stop the systemd service
make stop-sim-systemd
```

All methods use the same:
- Autoware workspace (`autoware/`)
- Map path configuration
- CycloneDDS settings (`cyclonedds.xml`)

This allows you to verify that different launch methods produce equivalent behavior.

### DDS Configuration

All launch methods use `cyclonedds.xml` which configures:
- Localhost-only communication (loopback interface)
- 65.5KB max message size
- 10MB socket buffer size

The `CYCLONEDDS_URI` environment variable is set before launching to ensure all nodes use this configuration.

### Systemd Service Details

When using `make start-sim-systemd`, the service:
- Runs as a user service (no sudo required)
- Automatically sources `autoware/install/setup.bash`
- Sets `CYCLONEDDS_URI` environment variable
- Copies `DISPLAY` environment variable for GUI applications (e.g., rviz2)
- Can be managed with standard systemd commands:
  ```bash
  # Check service status
  systemctl --user status ros2-autoware-planning-sim

  # View logs with journalctl
  journalctl --user -u ros2-autoware-planning-sim -f

  # Stop the service
  systemctl --user stop ros2-autoware-planning-sim
  ```

The Makefile targets (`make status-sim-systemd`, `make logs-sim-systemd`, etc.) provide convenient wrappers around these commands.
