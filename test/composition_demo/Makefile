SHELL := /bin/bash

.PHONY: help test-all test-record test-replay test-replay-standalone test-verify clean

help:
	@echo "ROS Composition Demo Test"
	@echo ""
	@echo "Targets:"
	@echo "  test-all              - Run all tests (record + replay + verify)"
	@echo "  test-record           - Record composition_demo.launch.py"
	@echo "  test-replay           - Replay with service-based loading"
	@echo "  test-replay-standalone - Replay in standalone mode"
	@echo "  test-verify           - Verify the replay worked"
	@echo "  clean                 - Clean generated files"
	@echo ""

test-all: clean test-record test-replay test-verify
	@echo ""
	@echo "‚úÖ All tests completed!"

test-record:
	@echo "üìù Recording composition demo..."
	@. /opt/ros/humble/setup.bash && \
	. ../../install/setup.bash && \
	ros2 run dump_launch dump_launch composition composition_demo.launch.py
	@echo "‚úÖ Recording complete: record.json created"
	@echo ""

test-replay:
	@echo "‚ñ∂Ô∏è  Replaying with service-based component loading..."
	@. /opt/ros/humble/setup.bash && \
	. ../../install/setup.bash && \
	timeout 5 ros2 run play_launch play_launch || true
	@echo "‚úÖ Replay complete (timed out after 5s as expected)"
	@echo ""

test-replay-standalone:
	@echo "‚ñ∂Ô∏è  Replaying in standalone mode..."
	@rm -rf play_log_standalone record_standalone.json
	@cp record.json record_standalone.json
	@. /opt/ros/humble/setup.bash && \
	. ../../install/setup.bash && \
	timeout 5 ros2 run play_launch play_launch \
		--input-file record_standalone.json \
		--log-dir play_log_standalone \
		--standalone-composable-nodes || true
	@echo "‚úÖ Standalone replay complete"
	@echo ""

test-verify:
	@echo "üîç Verifying replay results..."
	@./scripts/verify_replay.sh

clean:
	@echo "üßπ Cleaning up..."
	@rm -rf record.json record_standalone.json play_log play_log_standalone
	@echo "‚úÖ Cleanup complete"
